#+TITLE: TenderRender Frontend - Architecture
#+DATE: 2026-02-03

* Overview

React frontend for the TenderRender tender management platform. Connects directly to Supabase via RPC functions (no API gateway).

Multi-tenant application where each client sees only their own evaluated tenders. Client isolation enforced via =client_code= parameter in all RPC calls.

* Design Principles

| Principle | Description |
|-----------|-------------|
| Modularity | Focused components with single responsibilities |
| Colocation | Keep related code together (component + hooks in feature folders) |
| Composition | Build complex UIs from simple, reusable pieces |
| Type Safety | TypeScript everywhere, no =any= types |
| Server State First | TanStack Query for all API data; minimal client state |

* Tech Stack

| Layer | Choice | Reason |
|-------|--------|--------|
| Framework | Vite + React 19 | Fast builds, simple config, no SSR needed |
| Language | TypeScript | Type safety, Supabase has excellent types |
| Styling | Tailwind CSS 4 + Gold Executive Design System | Semantic token-based theming with Inter + Lora typography |
| Components | Custom UI Components | PixelBox, HealthBar, ArcadeButton primitives |
| Charts | Recharts | Composable, React-first charting library |
| Data | TanStack Query | Caching, loading states, refetching |
| Routing | React Router v6 | Client-side routing with URL params |
| Backend | Supabase | Direct RPC connection |

* Design System (Gold Executive)

Clean, professional design system using semantic CSS custom properties defined in =globals.css=.

| Element | Implementation |
|---------|----------------|
| Colors | Semantic tokens: =--color-primary= (gold), =--color-foreground=, =--color-muted=, =--color-destructive=, etc. |
| Typography | Inter (sans) for body, Lora (serif) for headings; weight 300 body, 600 headings |
| Containers | PixelBox renders =rounded-lg border border-border bg-card shadow-sm= |
| Numbers | LEDNumber renders =font-semibold tabular-nums= text |
| Progress | HealthBar renders rounded-full progress bar |
| Buttons | ArcadeButton with semantic variant classes (=bg-primary=, =bg-destructive=, etc.) |
| Badges | Rounded-pill badges with tinted backgrounds (=bg-success/10 text-success=) |
| Shadows | CSS custom property shadows: =--shadow-primary=, =--shadow-glow= |
| Animations | Subtle transitions: fade-in, slide-up, scale-in, shimmer |

Business-specific colors for tender domain are defined as tokens: =--color-excellent=, =--color-good=, =--color-review=, =--color-active=, etc.

See =src/components/quick_reference.org= for component implementation details.

* Project Structure

#+BEGIN_EXAMPLE
src/
├── App.tsx                    # Root component with routing and providers
├── main.tsx                   # Entry point with QueryClient setup
├── features/                  # Feature modules (domain logic)
│   ├── auth/                 # Authentication (login, context, components)
│   ├── tenders/              # Tender list, detail, filters (13 components, 5 hooks)
│   └── dashboard/            # Stats, alerts, activity (10 components, 2 hooks)
├── components/               # Shared UI components
│   ├── layout/               # AppShell, Header, Sidebar
│   ├── shared/               # Badges, States, Pagination
│   └── ui/                   # UI primitives (PixelBox, HealthBar, ArcadeButton, etc.)
├── lib/                      # Utilities and config
│   ├── supabase.ts           # Supabase client + getClientCode()
│   └── types.ts              # TypeScript interfaces (23 types)
├── hooks/                    # Global hooks (useToast)
├── contexts/                 # React contexts (ToastContext)
├── pages/                    # Route-level components (thin wrappers)
└── styles/                   # Global styles
#+END_EXAMPLE

See =src/lib/quick_reference.org= for detailed file contents.

* Provider Hierarchy

Application wrapping order in =main.tsx= and =App.tsx=:

#+BEGIN_EXAMPLE
StrictMode                       # React StrictMode (double-mount in dev)
└── QueryClientProvider          # TanStack Query (staleTime: 5min, no refetch on focus)
    └── AuthProvider             # Auth state (user, clientCode, login/logout)
        └── BrowserRouter        # React Router v6
            └── ToastProvider    # Toast notification state
                └── SidebarProvider  # Sidebar collapse state
                    └── ErrorBoundary    # Catches React component errors
                        └── AppShell     # Layout with Header + Sidebar
                            └── Routes   # Page components
#+END_EXAMPLE

| Provider | Purpose | Configuration |
|----------|---------|---------------|
| StrictMode | React dev checks | Double-mount in development |
| QueryClientProvider | Server state caching | staleTime: 5 minutes, refetchOnWindowFocus: false |
| AuthProvider | Authentication state | user, profile, clientCode, login/logout |
| BrowserRouter | Client-side routing | - |
| ToastProvider | Toast notification state | Auto-dismiss after 5 seconds |
| SidebarProvider | Sidebar collapse state | Expanded/collapsed toggle |
| ErrorBoundary | Error recovery | Renders fallback UI, reload button |

* Data Flow

#+BEGIN_EXAMPLE
User Action → Component → Custom Hook → TanStack Query → Supabase RPC → Database
                  ↑                           ↓
                  └────── Cached Response ────┘
#+END_EXAMPLE

| Step | Layer | Responsibility |
|------|-------|----------------|
| 1 | Component | Renders UI, handles user interactions |
| 2 | Hook | Encapsulates data fetching logic, parameters |
| 3 | TanStack Query | Manages cache, loading/error states, refetching |
| 4 | Supabase Client | Executes =supabase.rpc()= calls |
| 5 | Database | Returns data via RPC functions |

** Hook → RPC Function Mapping

| Hook | RPC Function | Location |
|------|--------------|----------|
| useDashboardStats | get_dashboard_stats | features/dashboard/hooks |
| useTenders | get_tenders_paginated | features/tenders/hooks |
| useTenderDetail | get_tender_detail | features/tenders/hooks |
| useFilterOptions | get_filter_options | features/tenders/hooks |
| useClientRubric | get_client_rubric | features/tenders/hooks |
| useActiveClientRubric | get_active_client_rubric | features/tenders/hooks |

See [[file:FUNCTIONS.org][FUNCTIONS.org]] for RPC function signatures.

* State Management

| State Type | Solution | Examples |
|------------|----------|----------|
| Server State | TanStack Query | Tender list, detail, dashboard stats |
| URL State | React Router | Selected tender ID, route |
| Filter State | Component useState | Relevance, province, search text |
| UI State | Component useState | Tab selection, sidebar collapsed |
| Global UI | React Context | Toast notifications |

*No Redux/Zustand needed* — server state is the bulk of this app.

* Routing

| Route | Page | Purpose |
|-------|------|---------|
| /login | LoginPage | Login screen (outside AppShell) |
| /reset-password | ResetPasswordPage | Password reset via Supabase callback |
| / | DashboardPage | Overview stats, alerts, recent activity |
| /tenders | TendersPage | Tender list with filters, no selection |
| /tenders/:tenderId | TendersPage | Tender list with detail panel open |
| /rubric | RubricPage | Client rubric display |
| * | Redirect to / | Catch-all |

URL parameter =:tenderId= enables direct linking to specific tenders.

* Pages Overview

** Dashboard (/)

At-a-glance metrics, alerts, featured tenders, and visualizations.

#+BEGIN_EXAMPLE
┌─────────────────────────────────────────────────────────────────────────────┐
│ Stats Grid (6 cards):                                                       │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────┐ │
│ │ Total    │ │ Relevant │ │Not Relev.│ │Excellent │ │ Good Fit │ │Review│ │
│ │ Active   │ │    42    │ │    28    │ │    8     │ │    18    │ │  16  │ │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────┘ │
├─────────────────────────────────────────────────────────────────────────────┤
│ Alerts Row (3 cards):                                                       │
│ ┌─────────────────────┐ ┌───────────────────┐ ┌─────────────────────────┐  │
│ │ 3 Briefings in 7d   │ │ 5 Closing in 7d   │ │ 2 Changes (24h)         │  │
│ └─────────────────────┘ └───────────────────┘ └─────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│ Charts (2-column grid):                                                     │
│ ┌──────────────────────┐  ┌─────────────────────┐                          │
│ │ Score Distribution   │  │ Department Treemap  │                          │
│ │ (Donut Chart)        │  │ (Top 12)            │                          │
│ └──────────────────────┘  └─────────────────────┘                          │
├─────────────────────────────────────────────────────────────────────────────┤
│ Tender Carousel (expand/collapse toggle for carousel vs. grid view)         │
│ ┌──────────┐  ┌──────────┐  ┌──────────┐                                   │
│ │ Tender 1 │  │ Tender 2 │  │ Tender 3 │  ← → ● ● ●                        │
│ └──────────┘  └──────────┘  └──────────┘                                   │
└─────────────────────────────────────────────────────────────────────────────┘
#+END_EXAMPLE

| Component | Data Source |
|-----------|-------------|
| StatsGrid | get_dashboard_stats → total_active, total_relevant, not_relevant, excellent_count, good_count, worth_reviewing_count |
| AlertsRow | get_dashboard_stats → briefings_next_7_days, closing_next_7_days, high_importance_changes_24h |
| ScoreDistributionChart | get_dashboard_stats → excellent_count, good_count, worth_reviewing_count |
| DepartmentTreemap | get_filter_options → departments with counts (top 12) |
| TenderCarousel | get_tenders_paginated → relevant tenders sorted by score descending (limit: 12), toggles between carousel and grid views |

See =src/features/dashboard/quick_reference.org= for component details.

** Tenders Page (/tenders) - Master-Detail Layout

Browse tenders and view details in a split-pane layout.

#+BEGIN_EXAMPLE
┌────────────────────────────────────────────────────────────────────────────┐
│ [≡] TenderRender                                              [pragma]     │
├────────┬───────────────────────────────────────────────────────────────────┤
│        │  ┌─────────────────────────┬────────────────────────────────────┐ │
│  Side  │  │    TENDER LIST (left)   │      TENDER DETAIL (right)         │ │
│  bar   │  │                         │                                    │ │
│        │  │ [Search box]  [Filter]  │  Title + Recommendation Badge      │ │
│ ┌────┐ │  │                         │  ─────────────────────────────     │ │
│ │Dash│ │  │ ┌─────────────────────┐ │                                    │ │
│ └────┘ │  │ │ ● Tender 1     [EX] │ │  Key Info Cards:                   │ │
│ ┌────┐ │  │ │   Health • 5d       │◄──│ ┌──────────┐ ┌──────────┐ ┌─────┐ │ │
│ │Tend│ │  │ └─────────────────────┘ │  │ │ Closes   │ │ Briefing │ │ 87% │ │ │
│ └────┘ │  │ ┌─────────────────────┐ │  │ │ 5 days   │ │ Feb 3 !  │ │score│ │ │
│ ┌────┐ │  │ │   Tender 2     [GD] │ │  │ └──────────┘ └──────────┘ └─────┘ │ │
│ │Rubr│ │  │ │   Treasury • 12d    │ │  │                                   │ │
│ └────┘ │  │ └─────────────────────┘ │  │ Tabs: [Opportunity] [Evaluation]  │ │
│        │  │                         │  │       [Documents] [Changes]       │ │
│        │  │ < 1 2 3 ... 10 >        │  │                                   │ │
│        │  │                         │  │ (Tab content below)               │ │
│        │  └─────────────────────────┴────────────────────────────────────┘ │
│        │                                                                    │
│        │  ╔═════════════════════════════════════════════════════════════╗  │
│        │  ║ FilterPopup Modal (opens on [Filter] click)                ║  │
│        │  ║ ┌─────────────────────────────────────────────────────────┐║  │
│        │  ║ │ Relevance:    [Relevant Only ▼]                          ││  │
│        │  ║ │ Status:       [Active ▼]                               ││  │
│        │  ║ │ Province:     [--- ▼]                                  ││  │
│        │  ║ │ Department:   [--- ▼]                                  ││  │
│        │  ║ │ Category:     [--- ▼]                                  ││  │
│        │  ║ │ Days Until Close: [Any ▼]                              ││  │
│        │  ║ │ Sort By:      [Published Date ▼] [Newest First]        ││  │
│        │  ║ │ [Apply] [Clear All]                                    ││  │
│        │  ║ └─────────────────────────────────────────────────────────┘║  │
│        │  ╚═════════════════════════════════════════════════════════════╝  │
└────────┴───────────────────────────────────────────────────────────────────┘
#+END_EXAMPLE

*** Component Hierarchy

#+BEGIN_EXAMPLE
TendersPage
├── TenderListPanel
│   ├── TenderListFilters (search box + Filter button)
│   │   └── FilterPopup (modal, opens on Filter button click)
│   ├── TenderListItem[] (list of tender cards)
│   └── Pagination
└── TenderDetailPanel (when tender selected)
    ├── TenderDetailHeader (title, recommendation, key info cards, lifecycle action bar)
    ├── TenderDetailTabs (tab navigation)
    └── Tab Content:
        ├── TenderOpportunityTab (AI assessment, description, metadata, contact)
        ├── TenderDetailEval (knockout + criteria results)
        ├── TenderDetailDocs (document list with download links)
        └── TenderDetailChanges (change history with field diffs)
#+END_EXAMPLE

*** Filter State

Managed in TenderListPanel and FilterPopup components:

| Filter | Type | Default |
|--------|------|---------|
| isRelevant | boolean or null | true (relevant only) |
| status | TenderStatus or null | 'active' |
| provinceId | number or null | null |
| departmentId | number or null | null |
| categoryId | number or null | null |
| minDaysUntilClose | number or null | null |
| searchText | string | "" |
| sortBy | string | "published_date" |
| sortDesc | boolean | true |
| page | number | 1 |
| limit | number | 25 |

Search updates apply immediately. All other filters apply via FilterPopup modal. Filters reset page to 1 on change. Results count shows "X of Y active tenders" using dashboard stats.

See =src/features/tenders/quick_reference.org= for FilterPopup implementation details.

*** Detail Panel Tabs

| Tab | Content | Component |
|-----|---------|-----------|
| Opportunity | AI quality assessment, description, metadata, contact | TenderOpportunityTab |
| Evaluation | Overall score, knockout results, criteria results | TenderDetailEval |
| Documents | Document list with download links | TenderDetailDocs |
| Changes | Change history timeline with field diffs | TenderDetailChanges |

Tab state managed locally in TenderDetailPanel.

See =src/features/tenders/quick_reference.org= for component details.

** Rubric Page (/rubric)

Displays the active client evaluation rubric.

| Section | Content |
|---------|---------|
| Header | Rubric name, version, description |
| Knockouts | Table of knockout questions with fail messages |
| Scoring Criteria | Table of criteria with weights and categories |
| Thresholds | Recommendation threshold ranges |

* Layout System

** AppShell Architecture

#+BEGIN_EXAMPLE
┌──────────────────────────────────────────────────────────────┐
│ Header (sticky top, z-40, bg-card border-b)                  │
│ [≡ burger] [Logo] [/ Page]                [profile dropdown] │
├────────────┬─────────────────────────────────────────────────┤
│            │                                                 │
│  Sidebar   │              Main Content                       │
│  (fixed,   │              (with margin-left, p-3)            │
│  bg-card,  │                                                 │
│  border-r) │                                                 │
│ ┌────────┐ │                                                 │
│ │  Dash  │ │                                                 │
│ │ Tender │ │                                                 │
│ │ Rubric │ │                                                 │
│ └────────┘ │                                                 │
│            │                                                 │
└────────────┴─────────────────────────────────────────────────┘
#+END_EXAMPLE

** Sidebar Collapse Behavior

| State | Sidebar Width | Content Margin |
|-------|---------------|----------------|
| Expanded | 224px (w-56) | ml-56 |
| Collapsed | 64px (w-16) | ml-16 |

- Burger menu in header toggles sidebar
- Expanded: shows icon + label
- Collapsed: shows icon only
- Active route highlighted with =bg-primary/10 text-primary=

See =src/components/quick_reference.org= for layout component details.

* Error Handling Strategy

Three-tier approach:

| Tier | Component | Purpose |
|------|-----------|---------|
| 1 | ErrorBoundary | Catches React component crashes, prevents full app failure |
| 2 | ErrorState | Explicit error display for API/query errors with retry button |
| 3 | Toast | Transient notifications for recoverable errors |

** ErrorBoundary

- Wraps entire app inside providers
- Uses =getDerivedStateFromError= to capture error state
- Renders fallback UI with reload button
- Location: =src/components/shared/ErrorBoundary.tsx=

** ErrorState

- Used in components when queries fail
- Shows title ("Error"), message, and optional retry button
- Uses =text-destructive= styling
- Location: =src/components/shared/ErrorState.tsx=

** Toast Notifications

- Three types: success ("Success"), error ("Error"), info ("Info")
- Card-style with colored left border accent (=border-l-success=, =border-l-destructive=, =border-l-info=)
- Auto-dismiss after 5 seconds
- Fixed bottom-right positioning
- Managed via ToastContext
- Location: =src/components/ui/Toast.tsx=, =Toaster.tsx=

* Component Guidelines

** Size Limits

| Guideline | Threshold |
|-----------|-----------|
| Max file size | ~500 lines acceptable |
| Split when | Logic becomes tangled or handles unrelated concerns |
| Hooks | Keep focused; split if doing too many things |

** Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| Components | PascalCase | =TenderListItem.tsx= |
| Hooks | camelCase with "use" prefix | =useTenders.ts= |
| Types | PascalCase | =TenderDetail= |
| Utilities | camelCase | =formatDate= |

** When to Split Components

Split when:
- Component handles multiple unrelated concerns
- Render logic exceeds ~50 lines of JSX
- Component has >3 useState hooks
- Reusable piece emerges

Keep together when:
- Tightly coupled (parent always renders child)
- Would require excessive prop drilling to split
- <100 lines total

* Key Concepts

** Recommendation Levels

| Level | Meaning | Badge Style |
|-------|---------|-------------|
| excellent_fit | Strong match, high priority | =bg-success/10 text-success= |
| good_fit | Good match, worth pursuing | =bg-info/10 text-info= |
| worth_reviewing | Potential fit, needs review | =bg-warning/10 text-warning= |
| not_recommended | Does not match criteria | =bg-muted text-muted-foreground= |

"Relevant" = any recommendation except =not_recommended=

** Change Importance

| Level | Meaning | Badge Style |
|-------|---------|-------------|
| high | Affects bid strategy (closing date, status, compulsory briefing) | =bg-destructive/10 text-destructive= |
| medium | Logistics impact (location, contact info) | =bg-warning/10 text-warning= |
| low | Informational (description edits) | =bg-muted text-muted-foreground= |

** Tender Status

| Status | Meaning | Badge Style |
|--------|---------|-------------|
| active | Open for bids | =bg-success/10 text-success= |
| awarded | Contract awarded | =bg-warning/10 text-warning= |
| closed | Bidding closed | =bg-muted text-muted-foreground= |
| cancelled | Tender cancelled | =bg-destructive/10 text-destructive= |

* Authentication Strategy

Supabase Auth with a two-effect architecture in AuthProvider to avoid deadlocking =navigator.locks=.

** Auth Flow

1. On mount, =onAuthStateChange= fires =INITIAL_SESSION= — sets =user= state only (no DB queries)
2. Separate effect watches =user= state, calls =fetchUserData()= outside the lock context
3. =fetchUserData()= queries =user_profiles= for profile, then =clients= for available clients
4. Sets =clientCode= from localStorage or first available client
5. All RPC calls use =clientCode= for multi-tenant isolation

** Auth State

| State | Type | Purpose |
|-------|------|---------|
| user | SupabaseUser or null | Supabase user from auth state changes |
| profile | UserProfile or null | Profile from user_profiles table |
| clientCode | string or null | Client identifier for RPC calls |
| isAuthenticated | boolean | True after successful data fetch |
| isLoading | boolean | Auth state loading |

** Login

Login form at =/login= accepts email/password. =signInWithPassword()= bypasses the cached =initializePromise=, then =fetchUserData()= loads profile and clients. Forgot password sends reset email via Supabase Auth, redirecting to =/reset-password=.

** Logout

Header displays logout button when authenticated. Calls =auth.logout()= to clear state and redirect to login.

* UI Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Tender list format | Cards in scrollable panel | Easy scanning, shows key info |
| Tender detail | Side panel (master-detail) | No navigation away from list |
| Sidebar | Collapsible with burger toggle | Maximizes content area when needed |
| Dark mode | Not implemented | Can add later if needed |
| Notifications | Toast system | Non-blocking, auto-dismissible |

* Related Documentation

| Document | Purpose |
|----------|---------|
| [[file:DATABASE.org][DATABASE.org]] | Schema tables, enums, JSONB structures |
| [[file:FUNCTIONS.org][FUNCTIONS.org]] | RPC functions, parameters, return types |
| [[file:DOCUMENTATION_PHILOSOPHY.org][DOCUMENTATION_PHILOSOPHY.org]] | Documentation standards and maintenance |
| [[file:src/features/auth/quick_reference.org][src/features/auth/quick_reference.org]] | Auth feature implementation details |
| [[file:src/features/tenders/quick_reference.org][src/features/tenders/quick_reference.org]] | Tenders feature implementation details |
| [[file:src/features/dashboard/quick_reference.org][src/features/dashboard/quick_reference.org]] | Dashboard feature implementation details |
| [[file:src/components/quick_reference.org][src/components/quick_reference.org]] | Shared component implementation details |
| [[file:src/lib/quick_reference.org][src/lib/quick_reference.org]] | Lib, pages, hooks, contexts details |
| [[file:context_files/frontend.md][context_files/frontend.md]] | API documentation from backend |

---
/Last Updated/: 2026-02-11
