#+TITLE: Auth Feature - Quick Reference
#+DATE: 2026-02-18

* Overview

Authentication via Supabase Auth with user profiles and multi-client support. Provides clean, modern login UI, forgot-password flow, auth state management, and client switching for StrideShift admins.

* Components

| Component | File | Purpose |
|-----------|------|---------|
| LoginCard | components/LoginCard.tsx:10 | Semantic login form with email/password and forgot-password link |
| ForgotPasswordModal | components/ForgotPasswordModal.tsx:9 | Modal for sending password reset email via Supabase |
| CombinedLogo | components/CombinedLogo.tsx:19 | Logo with StrideShift Global + TenderRender, pixel boot on load |
| PixelBootLoader | components/PixelBootLoader.tsx:14 | Animated spinner loader with pulsing text and crossfade |

* Contexts & Hooks

| Item | File | Purpose |
|------|------|---------|
| AuthProvider | contexts/AuthContext.tsx:40 | Provider with two-effect auth state management, deadlock-safe |
| useAuth | contexts/AuthContext.tsx:319 | Hook to access auth state and methods (login, logout, etc.) |
| isAbortError | contexts/AuthContext.tsx:19 | Detect AbortError in both DOMException and Supabase-wrapped forms |
| recoverSupabaseAuth | contexts/AuthContext.tsx:33 | Reset cached initializePromise and reinitialize auth client |

* Types

| Type | File | Key Fields |
|------|------|-----------|
| AuthState | types.ts:17 | user, profile, clientCode, availableClients, isStrideShift, isAuthenticated, isLoading |
| AuthContextValue | types.ts:27 | AuthState + login(), logout(), setActiveClient(), updatePassword(), forgotPassword() |
| UserProfile | types.ts:9 | user_id, client_pk (nullable), display_name, role, is_strideshift |
| Client | types.ts:3 | client_pk, client_code, client_name |

* AuthProvider Methods

| Method | Signature | Behavior |
|--------|-----------|----------|
| login | (email: string, password: string) => Promise<void> | Sign in via Supabase Auth, fetch user profile and clients |
| logout | () => Promise<void> | Sign out via Supabase, clear all state and localStorage |
| setActiveClient | (clientCode: string) => void | Switch active client, validate against availableClients |
| updatePassword | (newPassword: string) => Promise<void> | Update user password via Supabase Auth |
| forgotPassword | (email: string) => Promise<void> | Send password reset email via Supabase Auth |

* AuthProvider State

| Property | Type | Purpose |
|----------|------|---------|
| user | SupabaseUser \vert null | Raw Supabase user object from auth state changes |
| profile | UserProfile \vert null | User profile from user_profiles table |
| clientCode | string \vert null | Active client code for scoping queries |
| availableClients | Client[] | List of clients user has access to |
| isStrideShift | boolean | True if user.is_strideshift in profile |
| isAuthenticated | boolean | True after successful fetchUserData |
| isLoading | boolean | True during login or initial auth check |

* Authentication Flow (Two-Effect Architecture)

AuthProvider uses two separate effects to avoid deadlocking Supabase's internal navigator.locks mechanism.

** Effect 1: Auth State Listener (contexts/AuthContext.tsx:128)

- Subscribes to =supabase.auth.onAuthStateChange=
- ONLY sets =user= state from session—never calls DB queries
- Handles =SIGNED_OUT= (clears all state) and =INITIAL_SESSION= without session (stops loading)
- Avoids deadlock: =from().select()= cannot be called here (lock held by onAuthStateChange)

** Effect 2: User Data Fetcher (contexts/AuthContext.tsx:167)

- Watches =user= state—runs OUTSIDE onAuthStateChange callback (lock free)
- Calls =fetchUserData(userId)= (contexts/AuthContext.tsx:56) to load profile and clients
- Guarded by =isFetchingRef= (prevents concurrent) and =isManualLoginRef= (prevents login race)
- On AbortError: calls =recoverSupabaseAuth()=, then retries fetchUserData
- Always sets =isLoading=false= in finally (critical for React StrictMode)

** Login Flow (contexts/AuthContext.tsx:193)

1. =signInWithPassword()=—bypasses =initializePromise=, always works
2. Sets =user= state
3. Calls =fetchUserData()= directly (lock free after sign-in)
4. On AbortError: recovers auth, retries fetchUserData
5. =isManualLoginRef= prevents Effect 2 from racing

** AbortError Recovery

- =isAbortError()= detects both DOMException and Supabase-wrapped error objects
- =recoverSupabaseAuth()= resets =auth.initializePromise = null= and reinitializes
- React StrictMode double-mount can abort =navigator.locks.request()=, rejecting cached promise permanently

* LoginCard Props

| Prop | Type | Required | Description |
|------|------|----------|-------------|
| onLogin | (username: string, password: string) => void | Yes | Called when form submitted |
| onForgotPassword | () => void | No | Called when "FORGOT PASSWORD?" clicked |
| isLoading | boolean | Yes | Disables inputs, shows "LOGGING IN..." state |

* ForgotPasswordModal Props

| Prop | Type | Required | Description |
|------|------|----------|-------------|
| isOpen | boolean | Yes | Controls modal visibility |
| onClose | () => void | Yes | Called to dismiss modal |
| onSubmit | (email: string) => Promise<void> | Yes | Called with email to send reset link |

* CombinedLogo Props

| Prop | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| size | 'medium' \vert 'large' \vert 'xlarge' | No | 'large' | Logo size |
| showPixelBoot | boolean | No | false | Show PixelBootLoader animation |

* PixelBootLoader Props

| Prop | Type | Required | Default | Description |
|------|------|----------|---------|-------------|
| size | 'small' \vert 'medium' \vert 'large' | No | 'medium' | Spinner size (h-8, h-12, h-16) |
| color | string | No | hsl(45, 93%, 58%) | Border-top color for spinner |

* Client Switching (StrideShift Only)

- setActiveClient(newClientCode) validates client in availableClients
- Stores choice in localStorage at STORAGE_KEY='tenderrender_active_client'
- Regular users have single client, cannot switch
- StrideShift users see all active clients from clients table

* Theme Colors (HSL Semantic Tokens)

| Color | HSL Value | Used For |
|-------|-----------|----------|
| primary | hsl(45, 93%, 58%) | Gold buttons, links, primary accents |
| primary-foreground | hsl(240, 10%, 3.9%) | Text on primary background |
| muted | hsl(220, 14%, 96%) | Muted backgrounds, disabled states |
| muted-foreground | hsl(240, 8%, 35%) | Muted text, secondary labels |
| border | hsl(220, 14%, 90%) | Input/card borders, dividers |
| input | hsl(220, 14%, 96%) | Input field backgrounds |
| card | hsl(0, 0%, 100%) | Card backgrounds |
| foreground | hsl(240, 10%, 10%) | Primary text color |

* Supabase Auth Calls

| Method | Used By | Purpose |
|--------|---------|---------|
| signInWithPassword | login() | Authenticate user with email and password |
| signOut | logout() | Sign out user and clear session |
| updateUser | updatePassword() | Update user password via Auth |
| resetPasswordForEmail | forgotPassword() | Send password reset email |

* Database Access (Direct Queries)

| Table | Query Type | Used By | Purpose |
|-------|-----------|---------|---------|
| user_profiles | SELECT by user_id | fetchUserData | Fetch user profile and is_strideshift flag |
| clients | SELECT by is_active or client_pk | fetchUserData | Fetch available clients for user |

---
/Last Updated/: 2026-02-18
