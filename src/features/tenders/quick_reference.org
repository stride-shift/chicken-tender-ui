#+TITLE: Tenders Feature - Quick Reference
#+DATE: 2026-02-11

* Overview

Primary feature module for viewing and filtering tenders. Contains list/detail components and data fetching hooks.

* Components

| Component | File | Purpose |
|-----------|------|---------|
| TenderListPanel | TenderListPanel.tsx:27 | Container managing filters, pagination, "X of Y active tenders" count |
| TenderListItem | TenderListItem.tsx:11 | Single tender row: title, department, published date, closing date, recommendation badge |
| TenderListFilters | TenderListFilters.tsx:47 | Search box + Filter button (opens FilterPopup) |
| FilterPopup | FilterPopup.tsx:55 | Modal popup for applying tender filters with Apply/Clear |
| TenderDetailPanel | TenderDetailPanel.tsx:14 | Main detail panel with tabs and content |
| TenderDetailHeader | TenderDetailHeader.tsx:11 | Header with title, recommendation, key stats, lifecycle action bar |
| TenderDetailTabs | TenderDetailTabs.tsx:8 | Four-tab navigation bar |
| TenderDetailOverview | TenderDetailOverview.tsx:7 | Overview tab with description and metadata |
| TenderDetailDocs | TenderDetailDocs.tsx:7 | Documents tab listing files and downloads |
| TenderDetailChanges | TenderDetailChanges.tsx:9 | Change history tab with field diffs |
| TenderDetailContact | TenderDetailContact.tsx:8 | Contact information and briefing details |
| TenderDetailEval | TenderDetailEval.tsx:22 | Evaluation tab displaying rubric scores |
| TenderOpportunityTab | TenderOpportunityTab.tsx:10 | Opportunity tab with evaluator notes, AI summary, description, metadata |
| TenderRubricTab | TenderRubricTab.tsx:8 | Rubric definition display tab |

* Hooks

| Hook | File | RPC Function | Purpose |
|------|------|--------------|---------|
| useTenders | useTenders.ts:33 | get_tenders_paginated | Fetches paginated tender list with filters |
| useTenderDetail | useTenderDetail.ts:16 | get_tender_detail | Fetches single tender detail by PK |
| useFilterOptions | useFilterOptions.ts:14 | get_filter_options | Fetches province, department, category filter options |
| useClientRubric | useClientRubric.ts:5 | get_client_rubric | Fetches rubric definition by rubric PK |
| useActiveClientRubric | useActiveClientRubric.ts:10 | get_active_client_rubric | Fetches active rubric for current client |

* RPC Function Usage

| Function Called | Used By | Parameters | Purpose |
|-----------------|---------|------------|---------|
| get_tenders_paginated | useTenders | p_status, p_min_days_until_close, p_search_text, p_sort_by, p_sort_desc, p_is_relevant, p_province_id, p_department_id, p_category_id, p_limit, p_offset | Fetch paginated tender list with filters |
| get_tender_detail | useTenderDetail | | Fetch full tender detail |
| get_filter_options | useFilterOptions | | Fetch dynamic filter options |
| get_client_rubric | useClientRubric | | Fetch rubric definition |
| get_active_client_rubric | useActiveClientRubric | | Fetch active rubric for client |

* Component Hierarchy

TenderListPanel
├─ TenderListFilters (search + Filter button)
│  └─ FilterPopup (modal, shown when Filter button clicked)
└─ TenderListItem[] (list of tender cards)

TenderDetailPanel
├─ TenderDetailHeader (title, recommendation, days/briefing/score cards)
├─ TenderDetailTabs (tab navigation: Opportunity, Evaluation, Documents, Changes)
└─ Tab Content:
   ├─ TenderOpportunityTab (AI summary, description, metadata, contact)
   ├─ TenderDetailEval (rubric evaluation with knockouts/criteria)
   ├─ TenderDetailDocs (document list with download links)
   └─ TenderDetailChanges (change history with field diffs)

* Filter State

TenderFilters interface (useTenders.ts:6-16):
| Field | Type | Default |
|-------|------|---------|
| isRelevant | boolean \| null | true |
| provinceId | number \| null | null |
| departmentId | number \| null | null |
| categoryId | number \| null | null |
| searchText | string \| null | null |
| status | TenderStatus \| null | 'active' |
| minDaysUntilClose | number \| null | null |

Note: When =status='active'=, the RPC function automatically filters to only include tenders where =closing_date >= NOW()=, ensuring only truly open tenders are shown. This filter is applied server-side.
| sortBy | 'published_date' \| 'recommendation' \| 'closing_date' \| 'score' | 'published_date' |
| sortDesc | boolean | true |

FilterPopup manages local filter state and applies on user click.
TenderListFilters receives filters and passes updates via onFiltersChange (search) and onApplyFilters (popup).
Filters reset page to 1 on change.

* Tab Navigation

Four tabs in TenderDetailPanel:
1. Opportunity: Evaluator notes (llm_notes), AI summary (FormattedSummary), description, metadata, contact
2. Evaluation: Rubric-based scoring with knockouts and criteria
3. Documents: File list with download links
4. Changes: Change history with field-level diffs

Tab state managed locally in TenderDetailPanel component.

* Document Change Rendering

TenderDetailChanges handles document changes with =normalizeDocument= helper:
- Supports both string (legacy) and object formats for backwards compatibility
- Extracts =file_name= and =source_document_id= from document objects
- Displays source ID in muted text below filename

* TenderListFilters Component Details

TenderListFilters (TenderListFilters.tsx:47) is a simplified filter UI with:
- Search input (controls searchText filter)
- Filter button with active filter count badge
- FilterPopup modal that opens on button click

The component receives filter state and handler functions from parent (TenderListPanel).
Search updates are applied immediately via onFiltersChange.
All other filters (province, department, category, status, days, sort) are applied via FilterPopup.
Filter badge count increments when isRelevant !== true (default is true, so badge only shows if changed).

* FilterPopup Component Details

FilterPopup (FilterPopup.tsx:55) is a modal dialog with:
- Local state for filters (not applied until user clicks Apply)
- 6 dropdown filters: Relevance, Status, Province, Department, Category, Days Until Close
- Sort By dropdown (affects sortDesc automatically)
- Apply Filters button (calls onApply with local state)
- Clear All button (resets to defaults: isRelevant=true, status='active', sortBy='published_date', sortDesc=true)

Default sort logic: closing_date sorts ascending (sortDesc=false), all others sort descending (sortDesc=true).

* TenderDetailHeader Component Details

TenderDetailHeader (TenderDetailHeader.tsx:11) displays tender header with:
- Title (generated_title or tender_no), recommendation badge, closing date status
- Meta line: Tender number (if generated title), Closes (with days color coding), Briefing, Score
- Health bar showing score percentage (when score exists)
- Lifecycle action bar (skeleton, coming soon): Shortlist, Review, Watch, Decline buttons
  * All buttons call handleLifecycleAction which shows "Coming soon" toast via useToast hook
  * Button colors: Shortlist (success), Review (info), Watch (warning), Decline (muted)

* TenderListItem Component Details

TenderListItem (TenderListItem.tsx:11) displays a single tender row with:

| Element | Details | Line(s) |
|---------|---------|---------|
| Title | Generated title or truncated description (80 chars) | 13 |
| Department | Truncated to max-width 100px with ellipsis | 53 |
| Published Date | "X days ago" or "today" format | 19, 62 |
| Closing Date | "X days left", "today", or "Closed" with color coding | 20, 67-71 |
| Recommendation Badge | Pushed to far right with ml-auto | 74-75 |
| Urgent Indicator | Red text color when 1-3 days until close | 21, 67 |
| Closed Indicator | Gray text and "Closed" label when days_until_close < 0 | 22, 67, 101 |

Helper functions:
- =truncateText()= (line 82): Truncates with ellipsis
- =calculateDaysSince()= (line 87): Computes days between published_date and now
- =formatDaysSince()= (line 94): Formats as "today", "1d ago", or "Xd ago"
- =formatDaysUntilClose()= (line 100): Formats as "today", "1d left", "Xd left", or "Closed"

Date display: Published text is muted (stone-400), closing text uses conditional color (urgent=red-600, normal=stone-600, closed=stone-400).

---
/Last Updated/: 2026-02-11
